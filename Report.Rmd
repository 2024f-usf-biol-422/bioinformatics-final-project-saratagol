---
title: Analysis of SARS-CoV-2 Sequencing Data from Experimentally Infected Hamsters
  and Ferrets
author: "Sara Tagol"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: default
  pdf_document: default
csl: bioinformatics.csl
bibliography: references.bib
params:
  gff_file_path: data/metadata/sars_refgenome_annotation.gff
  vcf_dir_path: data/11_vcf_output_for_R
  sra_runtable_path: data/00_sra_runtable/SraRunTable.csv
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      error = FALSE)
library(dplyr)
library(ggplot2)
library(readr)
library(tidyr)
```


# Background and Overview

This is a report on SARS-CoV-2, including some variant analysis [@koyama2020variant].The primary goals of this analysis were to assess the genomic features and single nucleotide polymorphism (SNP) distribution within the SARS-CoV-2 genome using a combination of biostatistical tools. By using bash script for sequence processing and R for data analysis and visualization, this study aimed to identify patterns in SNP distribution and frequency, as well as their association with gene lengths across the viral genome in two non-model organisms. 
Using raw sequencing data which was then processed using bash tools such as bwa for sequence aligned and bcftools for variant calling. The file generated variant call format (VCF) files contain the SNP data. Next, to parse the VCF files, custom bash scripts were used to ensure the data was clean and ready for analysis. 
Using R, the cleaned data was imported and analysed to investigate the SNP distributions by sample and genomic location. These analyses included summarizing SNP counts, visualizing SNP distributions by gene, and looking at the relationship between gene length and SNP count. Figures including histograms, scatter plots and summary tables were made using the data to support these observations. 
The primary findings revealed that SNP counts varied a lot across genes, with the longer genes like ORF1ab and S having the highest SNP counts. This leads to possible correlations between gene length and SNP count. These observations are in line with the incredible genomic variation within SARS-CoV-2 and allow us to question why these specific genes might be so easily mutated. 
This project combined sequence processing pipelines with statistical analysis to create an overview of SNP dynamics in the SARS-CoV-2 genome in non-model organisms. 

# Methods

See the set of tutorials on the [vcfR package website](https://knausb.github.io/vcfR_documentation/index.html).

You may also want to use any of a range of different COVID data packages and data sources:

* https://kjhealy.github.io/covdata/
* https://github.com/como-ph/oxcovid19
* https://ropensci.org/blog/2020/10/20/searching-medrxivr-and-biorxiv-preprint-data/
* https://covidtracking.com/data/api
  * `readr::read_csv("https://api.covidtracking.com/v1/states/daily.csv")`

## Sequencing Data Analysis
Sequencing data were processed using `bwa` for alignment and `bcftools` for variant calling. The resulting VCF files were analyzed for variant frequencies and annotated with metadata.

## Tabular Data Analysis
The `SraRunTable.csv` was analyzed in R to summarize sample metadata and investigate patterns by region and sequencing platform.

All analyses were conducted using R scripts integrated into this RMarkdown file, ensuring reproducibility.

# Results and Discussion

```{r load-packages-and-functions, include=FALSE}
library("vcfR")
library("ggplot2")
library("dplyr")
library("ggthemes")

# this loads all function files in the code/functions directory
function_paths <- list.files("code/functions", full.names = TRUE)
purrr::walk(function_paths, source)
```

```{r load-sra-data, include=FALSE}
# Load the SRA data
sra_data <- read.csv("data/00_sra_runtable/SraRunTable.csv", header = TRUE)

# Check the first few rows and column names
head(sra_data)
colnames(sra_data)

# Extract treatment and simulate viral load
sra_data <- sra_data %>%
  mutate(
    treatment = case_when(
      grepl("paxlovid", Sample.Name, ignore.case = TRUE) ~ "Paxlovid",
      grepl("molnupiravir", Sample.Name, ignore.case = TRUE) ~ "Molnupiravir",
      grepl("nirmatrelvir", Sample.Name, ignore.case = TRUE) ~ "Nirmatrelvir",
      TRUE ~ "Other"
    ),
    viral_load = abs(rnorm(nrow(sra_data), mean = 1e5, sd = 2e4)) # Simulate viral load for demonstration
  )

# Check data
head(sra_data)
```

```{r load-vcf-data, include=FALSE}
# load in, tidy, and stack all of the VCF files in the target directory
# these are the output of the bash pipeline
stacked_vcfs <- parse_tidy_and_stack_vcfs(vcf_dir_path = params$vcf_dir_path)

# load in the gff file with genome annotations for SARS-CoV-2
gff <- read_gff(gff_file_path = params$gff_file_path)

# pull out just the named genes from the annotation file
gene_table <- extract_genes_from_gff(annotation_object = gff)

# combine the stacked vcf table with the gene names and the metadata from
# the sra runtable file
vcf_with_metadata <-
  add_genes_metadata_to_vcfstack(sra_runtable_path = params$sra_runtable_path,
                                 stacked_vcf = stacked_vcfs,
                                 cleaned_genes_table = gene_table)
```

# Figures

```{r unique SNP locations, fig.cap="Figure 1: ORF1ab and S genes have more unique SNPs in the set of samples analyzed."}
# create a plot of unique SNP locations within each gene across all samples
vcf_with_metadata %>%
  filter(!is.na(gene)) %>% # get rid of SNPs not in gene regions
  group_by(gene, pos) %>%
  tally() %>% # this gives a column n for the number of gene by position
  group_by(gene) %>%
  tally() %>% # this collapses that down to the number of unique SNP locations
  ggplot(aes(x = gene,
             y = n)) +
  geom_col() +
  labs(title = "Count of distinct SNPs in Named SARS-CoV-2 Genes",
       x = "Gene Name") +
  theme_few() # get rid of the grey background
```



```{r snp-distribution-genome, fig.cap="Figure 2: Most SNPs occur between 20,000 and 25,000 bp."}
vcf_with_metadata %>%
  ggplot(aes(x = pos)) +
  geom_histogram(binwidth = 1000, fill = "orange", color = "black") +
  labs(title = "SNP Distribution Across the Genome",
       x = "Genomic Position (bp)",
       y = "Frequency of SNPs") +
  theme_minimal()
```

```{r ferret-hamster-sample-count, fig.cap="Figure 3: Roborovski dwarf hamster has more SNPs than ferret."}
vcf_with_metadata %>%
  filter(!is.na(lab_host) & lab_host %in% c("ferret", "Roborovski dwarf hamster")) %>%
  group_by(lab_host) %>%
  summarize(snp_count = n()) %>%
  ggplot(aes(x = lab_host, y = snp_count, fill = lab_host)) +
  geom_bar(stat = "identity") +
  labs(
    title = "SNP Count for Ferrets vs Hamsters",
    x = "Lab Host",
    y = "Number of SNPs"
  ) +
  scale_fill_manual(values = c("ferret" = "purple", "Roborovski dwarf hamster" = "orange")) +
  theme_minimal()
```

```{r snp-counts-sample, fig.cap="Figure 4: There is a variety in number of SNPs per sample."}
vcf_with_metadata %>%
  group_by(sample) %>%
  summarize(snp_count = n()) %>%
  ggplot(aes(x = reorder(sample, snp_count), y = snp_count)) +
  geom_bar(stat = "identity", fill = "purple") +
  labs(title = "SNP Counts Per Sample",
       x = "Sample ID",
       y = "Number of SNPs") +
  theme_minimal() +
  theme(axis.text.x = element_blank(), # Hides overlapping labels
        axis.ticks.x = element_blank()) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)))
```

```{r gene-length-distribution, fig.cap="Figure 5: ORF1ab and S genes are much larger in length than the other genes."}
# create a plot of gene length distribution 
gene_table %>%
  mutate(length = end - start) %>%
  ggplot(aes(x = length)) +
  geom_histogram(binwidth = 100, fill = "darkblue", color = "white") +
  labs(title = "Gene Length Distribution",
       x = "Gene Length (bp)", y = "Frequency") +
  theme_minimal()
```

```{r snp-gene-length-correlation, fig.cap="Figure 6: Another way to demonstrate ORF1ab and S genes are larger genes and therfore are more likely to have SNPs."}
# create a plot of correlation Between SNP Counts and Gene Length
gene_table_with_snps <- vcf_with_metadata %>%
  filter(!is.na(gene)) %>%
  group_by(gene) %>%
  summarize(snp_count = n()) %>%
  left_join(gene_table, by = c("gene" = "gene_name")) %>%
  mutate(length = end - start)

ggplot(gene_table_with_snps, aes(x = length, y = snp_count)) +
  geom_point(color = "red", size = 3) +
  labs(title = "Correlation Between SNP Counts and Gene Length",
       x = "Gene Length (bp)", y = "Number of SNPs") +
  theme_minimal()
```

# Tables

```{r gene-summary-table}
# A table with a summary of Gene Information
gene_table %>%
  mutate(length = end - start) %>%
  select(gene_name, start, end, length) %>%
  knitr::kable(col.names = c("Gene Name", "Start", "End", "Length (bp)"))
```
**Table 1**: Gene names, locations, and lengths in the SARS-CoV-2 genome.
```{r top-snps-genes-table}
# A table with top 5 Genes with Highest SNP Counts
vcf_with_metadata %>%
  filter(!is.na(gene)) %>%
  group_by(gene) %>%
  summarize(snp_count = n()) %>%
  arrange(desc(snp_count)) %>%
  head(5) %>%
  knitr::kable(col.names = c("Gene Name", "SNP Count"))
```
**Table 2**: Gene names and SNP counts. Higher SNP counts in the S and ORF1ab genes are possibly related to the larger size of these genes.
# Sources Cited
